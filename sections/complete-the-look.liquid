{%- liquid
  assign section_title = section.settings.section_title
  assign link_text = section.settings.link_text
  assign link_url = section.settings.link_url
  assign bg_color = section.settings.background_color
  assign page_padding = section.settings.page_padding | default: 80 | append: 'px'
  assign page_padding_top = section.settings.page_padding_top | default: 50 | append: 'px'
  assign page_padding_bottom = section.settings.page_padding_bottom | default: 50 | append: 'px'

  assign products_per_row_mobile = section.settings.products_per_row_mobile
  assign mobile_grid_item_width = 100 | divided_by: products_per_row_mobile
  
  assign show_variant_picker = section.settings.show_variant_picker

  comment
    'GET PRODUCTS FROM METAFIELD AND LIMIT TO 10'
  endcomment
  assign product_handles_string = product.metafields.sbs.the_look.value
  if product_handles_string != blank
    assign product_handles = product_handles_string | split: ',' | slice: 0, 10
  else
    assign product_handles = ''
  endif
-%}

<style>
  #CompleteTheLook-{{ section.id }} {
    --products-per-row-mobile: {{ products_per_row_mobile }};
    --mobile-grid-item-width: {{ mobile_grid_item_width }}%;
    --page-padding: {{ page_padding }};
  }

  #CompleteTheLook-{{ section.id }} .complete-the-look {
    padding-top: {{ page_padding_top }};
    padding-bottom: {{ page_padding_bottom }};
  }

  #CompleteTheLook-{{ section.id }} .page-width {
    padding: 0 var(--page-padding);
  }

  .complete-the-look__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }

  .complete-the-look__title {
    font-family: 'ButlerPro';
    font-style: normal;
    font-weight: 500;
    font-size: 32px;
    line-height: 100%;
    margin-bottom: 0;
    margin-top: 0;
    color: #000000;
  }

  .complete-the-look__link {
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 700;
    font-size: 18px;
    letter-spacing: 0.015em;
    color: #000000;
  }

  .complete-the-look__link svg {
    width: 24px;
    height: 14px;
    margin-bottom: 5px;
    transition: transform 0.3s ease;
  }

  .complete-the-look__link:hover svg {
    transform: translateX(5px);
  }

  .complete-the-look__slider-wrapper {
    position: relative;
    margin-left: {{ page_padding }};
  }

  .complete-the-look__grid {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 250px;
    list-style-type: none;
    gap: 16px;
    overflow-x: auto;
    scroll-behavior: smooth;
    -ms-overflow-style: none;
    scrollbar-width: none;
    padding-bottom: 20px;
    padding-left: 0;
    padding-right: var(--page-padding);
    margin: 0;
  }


  .complete-the-look__grid::-webkit-scrollbar {
    display: none;
  }

  .complete-the-look__slider-arrow {
    position: absolute;
    top: 30%;
    width: 42px;
    height: 42px;
    border-radius: 100%;
    background-color: #FAFAF8;
    opacity: 0.9;
    border: 1px solid rgba(0,0,0,0.05);
    cursor: pointer;
    z-index: 2;
    box-shadow: 8px 8px 30px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.3s ease;
    filter: drop-shadow(8px 8px 30px rgba(0, 0, 0, 0.2));
  }

  .complete-the-look__slider-arrow:hover {
    opacity: 1;
    background-color: #e8e6e6;
    transform: scale(1.15);
  }


  .complete-the-look__slider-arrow--prev {
    left: calc(var(--page-padding) - 21px);
  }

  .complete-the-look__slider-arrow--next {
    right: var(--page-padding);
  }

  .complete-the-look__slider-arrow svg {
    width: 15.42px;
    height: 12px;
    color: #483E3F;
  }

  .complete-the-look__slider-arrow.is-hidden {
    display: none;
  }

  @media (max-width: 768px) {
     #CompleteTheLook-{{ section.id }} .page-width {
        padding: 0 15px;
    }

    .complete-the-look__header {
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 20px;
      gap: 4px;
    }

    .complete-the-look__title {
      font-size: 22px;
    }

     .complete-the-look__link {
      font-size: 14px;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .complete-the-look__link svg {
      display: none;
    }

    .complete-the-look__slider-wrapper {
      margin: 0;
    }

    .complete-the-look__grid {
      grid-auto-columns: calc(var(--mobile-grid-item-width) - 15px + (15px / var(--products-per-row-mobile)));
      scroll-snap-type: x mandatory;
      gap: 15px;
      padding-left: 15px;
      padding-right: 15px;
    }

    .complete-the-look__product-card {
      scroll-snap-align: start;
    }

    .complete-the-look__slider-arrow {
      display: none;
    }
  }
</style>

<complete-the-look-slider id="CompleteTheLook-{{ section.id }}">
  {%- if product_handles.size > 0 -%}
    <div class="complete-the-look" style="background-color: {{ bg_color }};">
      <div class="page-width">
        {% if section_title != blank or link_text != blank %}
          <div class="complete-the-look__header">
            {% if section_title != blank %}
              <h2 class="complete-the-look__title">{{ section_title | escape }}</h2>
            {% endif %}

            {% if link_text != blank and link_url != blank %}
              <a href="{{ link_url }}" class="complete-the-look__link">
                <span>{{ link_text | escape }}</span>
                <svg width="24" height="14" viewBox="0 0 24 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20.056 8.02073C20.0738 8.00261 20.07 7.99354 20.0447 7.99354C8.8638 7.99385 12.1814 7.99385 0.99707 7.99354C0.598165 7.99354 0.218007 7.75026 0.0741014 7.37948C-0.13918 6.82823 0.120508 6.22495 0.691445 6.04448C0.795507 6.01167 1.08285 5.99526 1.08285 5.99526C1.08285 5.99526 8.79677 5.99714 20.0358 5.99714C20.0677 5.99714 20.0724 5.98604 20.0499 5.96386C18.6324 4.54729 17.229 3.14323 15.8396 1.75167C15.7127 1.62479 15.6272 1.51026 15.5832 1.40807C15.2086 0.539949 16.0683 -0.278957 16.9266 0.0913558C17.0297 0.136043 17.1943 0.271981 17.4202 0.499169C19.2933 2.38292 21.1603 4.2512 23.0213 6.10401C23.2147 6.2962 23.3358 6.44089 23.3846 6.53807C23.5721 6.91167 23.5135 7.38651 23.2139 7.68604C21.2411 9.65979 19.2474 11.6548 17.2327 13.671C16.7968 14.107 16.1119 14.1112 15.7168 13.6204C15.4008 13.2271 15.4257 12.6524 15.7805 12.2967C17.2061 10.8692 18.6313 9.44386 20.056 8.02073Z" fill="#180405"/>
                </svg>
              </a>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="complete-the-look__slider-wrapper">
        <ul class="complete-the-look__grid js-slider" role="list">
          {%- for handle in product_handles -%}
            {%- assign product_item = all_products[handle] -%}
            {%- if product_item and product_item != empty -%}
              <li class="complete-the-look__product-card">
                {%- render 'product-card', product: product_item, show_variants: show_variant_picker -%}
              </li>
            {%- endif -%}
          {%- endfor -%}
        </ul>

        <button
          class="complete-the-look__slider-arrow complete-the-look__slider-arrow--prev js-slider-prev is-hidden"
          aria-label="Previous"
        >
          <svg
            transform="scale(-1 1)"
            width="16"
            height="12"
            viewBox="0 0 16 12"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M12.4958 6.87812C12.511 6.86258 12.5078 6.85481 12.4863 6.85481C2.96734 6.85507 10.3707 6.85507 0.848845 6.85481C0.509235 6.85481 0.185587 6.64618 0.0630715 6.32822C-0.118506 5.8555 0.10258 5.33816 0.58865 5.1834C0.677243 5.15526 0.921875 5.1412 0.921875 5.1412C0.921875 5.1412 2.91028 5.1428 12.4787 5.1428C12.5058 5.1428 12.5098 5.13329 12.4907 5.11426C11.2839 3.8995 10.089 2.69546 8.9062 1.50213C8.79818 1.39333 8.72542 1.29511 8.6879 1.20748C8.36905 0.46303 9.10094 -0.239217 9.83165 0.0783415C9.91944 0.116663 10.0595 0.233236 10.2519 0.428059C11.8466 2.04346 13.436 3.64559 15.0204 5.23445C15.185 5.39926 15.2881 5.52334 15.3296 5.60668C15.4893 5.92705 15.4394 6.33425 15.1844 6.59111C13.5048 8.28369 11.8075 9.99448 10.0922 11.7235C9.7211 12.0973 9.13806 12.101 8.80164 11.6801C8.53267 11.3428 8.55382 10.85 8.85591 10.5449C10.0696 9.32078 11.2829 8.09851 12.4958 6.87812Z" fill="currentColor"/>
          </svg>
        </button>

        <button
          class="complete-the-look__slider-arrow complete-the-look__slider-arrow--next js-slider-next"
          aria-label="Next"
        >
          <svg width="16" height="12" viewBox="0 0 16 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12.4958 6.87812C12.511 6.86258 12.5078 6.85481 12.4863 6.85481C2.96734 6.85507 10.3707 6.85507 0.848845 6.85481C0.509235 6.85481 0.185587 6.64618 0.0630715 6.32822C-0.118506 5.8555 0.10258 5.33816 0.58865 5.1834C0.677243 5.15526 0.921875 5.1412 0.921875 5.1412C0.921875 5.1412 2.91028 5.1428 12.4787 5.1428C12.5058 5.1428 12.5098 5.13329 12.4907 5.11426C11.2839 3.8995 10.089 2.69546 8.9062 1.50213C8.79818 1.39333 8.72542 1.29511 8.6879 1.20748C8.36905 0.46303 9.10094 -0.239217 9.83165 0.0783415C9.91944 0.116663 10.0595 0.233236 10.2519 0.428059C11.8466 2.04346 13.436 3.64559 15.0204 5.23445C15.185 5.39926 15.2881 5.52334 15.3296 5.60668C15.4893 5.92705 15.4394 6.33425 15.1844 6.59111C13.5048 8.28369 11.8075 9.99448 10.0922 11.7235C9.7211 12.0973 9.13806 12.101 8.80164 11.6801C8.53267 11.3428 8.55382 10.85 8.85591 10.5449C10.0696 9.32078 11.2829 8.09851 12.4958 6.87812Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  {%- endif -%}
</complete-the-look-slider>

<script>
  if (!customElements.get('complete-the-look-slider')) {
    class CompleteTheLookSlider extends HTMLElement {
      constructor() {
        super();
        this.scrollDistance = 0;
      }

      connectedCallback() {
        setTimeout(() => {
          this.init();
        }, 0);
      }

      init() {
        this.slider = this.querySelector('.js-slider');

        if (!this.slider) {
          console.error('Complete The Look Slider (init): The .js-slider element element was not found.', this);
          return;
        }

        if (this.dataset.initialized) {
          return;
        }

        const firstProduct = this.slider.querySelector('.complete-the-look__product-card');
        if (firstProduct) {
          const sliderStyles = window.getComputedStyle(this.slider);
          const productGap = parseFloat(sliderStyles.gap) || 0;
          this.scrollDistance = firstProduct.offsetWidth + productGap;
        }

        this.prevButton = this.querySelector('.js-slider-prev');
        this.nextButton = this.querySelector('.js-slider-next');

        this.prevButton.addEventListener('click', this.onPrevClick.bind(this));
        this.nextButton.addEventListener('click', this.onNextClick.bind(this));
        this.slider.addEventListener('scroll', this.updateButtonVisibility.bind(this));

        new ResizeObserver(() => this.updateButtonVisibility()).observe(this.slider);

        requestAnimationFrame(() => this.updateButtonVisibility());

        this.dataset.initialized = 'true';
      }

      onPrevClick() {
        this.slider.scrollBy({ left: -this.scrollDistance, behavior: 'smooth' });
      }

      onNextClick() {
        this.slider.scrollBy({ left: this.scrollDistance, behavior: 'smooth' });
      }

      updateButtonVisibility() {
        if (!this.slider || !this.slider.clientWidth) return;

        const maxScroll = this.slider.scrollWidth - this.slider.clientWidth;

        this.prevButton.classList.toggle('is-hidden', this.slider.scrollLeft <= 0);
        this.nextButton.classList.toggle('is-hidden', this.slider.scrollLeft >= maxScroll - 1);
      }
    }

    customElements.define('complete-the-look-slider', CompleteTheLookSlider);
  }
</script>

{% schema %}
{
  "name": "Complete The Look",
  "tag": "section",
  "class": "section--full-width",
  "settings": [
    {
      "type": "header",
      "content": "Section Source Information"
    },
    {
      "type": "paragraph",
      "content": "This section automatically displays products from the 'sbs.the_look' metafield of the current product. To change the products, edit the metafield on the product page. A maximum of 10 products will be shown."
    },
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "Complete The Look"
    },
    {
      "type": "text",
      "id": "link_text",
      "label": "Link text"
    },
    {
      "type": "url",
      "id": "link_url",
      "label": "Link URL"
    },
    {
      "type": "range",
      "id": "page_padding",
      "label": "Page Padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 80
    },
    {
      "type": "range",
      "id": "page_padding_top",
      "label": "Page Padding Top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 50
    },
    {
      "type": "range",
      "id": "page_padding_bottom",
      "label": "Page Padding Bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 50
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "checkbox",
      "id": "show_variant_picker",
      "label": "Show / Hide Variant Picker",
      "default": true
    },
    {
      "type": "radio",
      "id": "products_per_row_mobile",
      "label": "Products per row (mobile)",
      "options": [
        { "value": "1", "label": "One" },
        { "value": "2", "label": "Two" }
      ],
      "default": "2"
    }
  ],
  "presets": [
    {
      "name": "Complete The Look"
    }
  ]
}
{% endschema %}
